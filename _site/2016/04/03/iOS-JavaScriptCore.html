<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="baidu-site-verification" content="w9Akh6dPe4" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<!--[if lte IE 8]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

<title>iOS JavaScriptCore使用 | 曾绍明的博客</title>
<meta name="author" content="曾绍明">




<link rel="shortcut icon" href="" />

<link rel="stylesheet" type="text/css" href="/assets/css/style.css">

<link href="/pages/rss.xml" rel="alternate" title="曾绍明的博客" type="application/atom+xml">



  </head>
  <body>
        <aside id="sidebar">
  <nav id="tags">
    <a href="/index.html" id="avatar" style="background-image:url(https://avatars1.githubusercontent.com/u/15245912)"></a>

    <ul id="tags__ul">
      <li id="pl__all" class="tags__li tags-btn active">所有文章</li>
       
        <li id="技术" class="tags__li tags-btn">技术</li>
       
        <li id="web前端" class="tags__li tags-btn">web前端</li>
       
        <li id="专题" class="tags__li tags-btn">专题</li>
       
        <li id="iOS" class="tags__li tags-btn">iOS</li>
       
        <li id="生活" class="tags__li tags-btn">生活</li>
       
        <li id="react-native" class="tags__li tags-btn">react-native</li>
       
        <li id="其他" class="tags__li tags-btn">其他</li>
       
        <li id="IoT" class="tags__li tags-btn">IoT</li>
      
    </ul>

    <div id="tags__bottom">
      <a href="http://github.com/ZSMSimon" id="icon-github" class="tags-btn fontello" target="_blank"></a>
      <a href="/pages/rss.xml" id="icon-feed" class="tags-btn fontello" target="_blank"></a>
      <a href="mailto:ZSMSimon@163.com" id="icon-email" class="tags-btn fontello"></a>
    </div>
  </nav> <!-- end #tags -->

  <div id="posts-list">
    <form action="" id="search-form">
      <a href="/index.html" id="mobile-avatar" style="background-image:url(https://avatars1.githubusercontent.com/u/15245912)"></a>
      <!-- NOTE: input field is disabled by default -->
      <input id="search-input" type="text" placeholder="Search..." >
    </form>

    <nav id="pl__container">
    
      <a class="IoT pl__all" href="/2017/05/16/JavaScript-mqtt-temperaturedemo.html"><span class="pl__circle"></span><span class="pl__title">IoT技术选型及模型设计的思考</span><span class="pl__date">17/05/16</span></a>
    
      <a class="IoT pl__all" href="/2017/05/02/hello-nodemcu.html"><span class="pl__circle"></span><span class="pl__title">hello nodemcu</span><span class="pl__date">17/05/02</span></a>
    
      <a class="其他 pl__all" href="/2017/03/16/Recruitment.html"><span class="pl__circle"></span><span class="pl__title">阿里云iot事业部招聘信息</span><span class="pl__date">17/03/16</span></a>
    
      <a class="技术 pl__all" href="/2017/01/23/zhihu-live-a-hour-for-bluetooth-0.html"><span class="pl__circle"></span><span class="pl__title">知乎live：一小时蓝牙科普 文字整理版</span><span class="pl__date">17/01/23</span></a>
    
      <a class="web前端 pl__all" href="/2016/12/08/eslint-guide.html"><span class="pl__circle"></span><span class="pl__title">ESLint使用</span><span class="pl__date">16/12/08</span></a>
    
      <a class="其他 pl__all" href="/2016/12/06/how-to-fupan.html"><span class="pl__circle"></span><span class="pl__title">柳传志：我的复盘方法论</span><span class="pl__date">16/12/06</span></a>
    
      <a class="react-native pl__all" href="/2016/11/14/react-native-flux%E6%95%B0%E6%8D%AE%E6%B5%81.html"><span class="pl__circle"></span><span class="pl__title">flux数据流在rn中的使用</span><span class="pl__date">16/11/14</span></a>
    
      <a class="专题 pl__all" href="/2016/05/09/iOS-networking-0.html"><span class="pl__circle"></span><span class="pl__title">iOS 网络请求专题</span><span class="pl__date">16/05/09</span></a>
    
      <a class="iOS pl__all" href="/2016/04/03/iOS-JavaScriptCore.html"><span class="pl__circle"></span><span class="pl__title">iOS JavaScriptCore使用</span><span class="pl__date">16/04/03</span></a>
    
      <a class="iOS pl__all" href="/2016/04/02/iOS-3DTouch-3.html"><span class="pl__circle"></span><span class="pl__title">iOS 3D touch开发(三) Force Properties-按压力度</span><span class="pl__date">16/04/02</span></a>
    
      <a class="iOS pl__all" href="/2016/04/01/iOS-3DTouch-2.html"><span class="pl__circle"></span><span class="pl__title">iOS 3D touch开发(二) peek and pop - 预览和弹出</span><span class="pl__date">16/04/01</span></a>
    
      <a class="iOS pl__all" href="/2016/03/21/iOS-3DTouch-1.html"><span class="pl__circle"></span><span class="pl__title">iOS 3D touch开发(一) Home Screen Quick Actions</span><span class="pl__date">16/03/21</span></a>
    
      <a class="iOS pl__all" href="/2016/03/10/iOS-unit-test.html"><span class="pl__circle"></span><span class="pl__title">iOS单元测试</span><span class="pl__date">16/03/10</span></a>
    
      <a class="iOS pl__all" href="/2016/02/29/iOS-objc-styleguide.html"><span class="pl__circle"></span><span class="pl__title">iOS objc编程规范</span><span class="pl__date">16/02/29</span></a>
    
      <a class="iOS pl__all" href="/2016/02/13/ios-networking-5.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（五）网络请求中的cookie</span><span class="pl__date">16/02/13</span></a>
    
      <a class="iOS pl__all" href="/2016/02/09/ios-networking-4.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（四） http异步文件上传和下载以及进度指示</span><span class="pl__date">16/02/09</span></a>
    
      <a class="iOS pl__all" href="/2016/02/04/ios-networking-3.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（三） http异步请求和https认证</span><span class="pl__date">16/02/04</span></a>
    
      <a class="iOS pl__all" href="/2016/02/03/ios-networking-2.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（二） http异步队列请求</span><span class="pl__date">16/02/03</span></a>
    
      <a class="iOS pl__all" href="/2016/02/03/ios-networking-1.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（一） http同步请求</span><span class="pl__date">16/02/03</span></a>
    
      <a class="react-native pl__all" href="/2016/02/02/react-native-demo.html"><span class="pl__circle"></span><span class="pl__title">react-native（二） 自己写的react-native学习demo和整理的tips</span><span class="pl__date">16/02/02</span></a>
    
      <a class="react-native pl__all" href="/2016/01/11/react-native-helloworld.html"><span class="pl__circle"></span><span class="pl__title">react-native（一） hello world</span><span class="pl__date">16/01/11</span></a>
    
      <a class="iOS pl__all" href="/2016/01/06/iOS-app-versions.html"><span class="pl__circle"></span><span class="pl__title">api如何设计才能支撑多个不同版本的app共存</span><span class="pl__date">16/01/06</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/31/playwith-imageToAscii.html"><span class="pl__circle"></span><span class="pl__title">那些好玩的nodejs插件 - 把图片转为ascii</span><span class="pl__date">15/12/31</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/10/fe-componentization.html"><span class="pl__circle"></span><span class="pl__title">前端开发框架 - seajs+handlebars模块化开发</span><span class="pl__date">15/12/10</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/06/fe-nginx-usage.html"><span class="pl__circle"></span><span class="pl__title">mac环境nginx的安装和使用</span><span class="pl__date">15/12/06</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/03/fe-js-handlebars.html"><span class="pl__circle"></span><span class="pl__title">handlerbars的使用及模板预编译</span><span class="pl__date">15/12/03</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/01/fe-engineering-gulp.html"><span class="pl__circle"></span><span class="pl__title">gulp自动构建工具教程</span><span class="pl__date">15/12/01</span></a>
    
      <a class="web前端 pl__all" href="/2015/11/27/fe-environment.html"><span class="pl__circle"></span><span class="pl__title">前端开发工具和环境搭建</span><span class="pl__date">15/11/27</span></a>
    
      <a class="web前端 pl__all" href="/2015/11/26/rem-em-px.html"><span class="pl__circle"></span><span class="pl__title">css3属性rem的使用</span><span class="pl__date">15/11/26</span></a>
    
      <a class="生活 pl__all" href="/2015/11/26/mylift-github.html"><span class="pl__circle"></span><span class="pl__title">我每天都在github上做些什么</span><span class="pl__date">15/11/26</span></a>
    
      <a class="iOS pl__all" href="/2015/11/24/iOS-affine-transfermation-animation.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（七）仿射变换-CGAffineTransform</span><span class="pl__date">15/11/24</span></a>
    
      <a class="iOS pl__all" href="/2015/11/22/iOS-library-spring.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（六）swift动画库spring使用和代码拆解</span><span class="pl__date">15/11/22</span></a>
    
      <a class="iOS pl__all" href="/2015/11/16/iOS-Implicit-Animation.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（五）layer隐式动画</span><span class="pl__date">15/11/16</span></a>
    
      <a class="iOS pl__all" href="/2015/11/06/iOS-controller-transitioning.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（四）controller间的自定义过渡效果</span><span class="pl__date">15/11/06</span></a>
    
      <a class="iOS pl__all" href="/2015/11/01/iOS-MotionEffects.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（三）MotionEffects</span><span class="pl__date">15/11/01</span></a>
    
      <a class="iOS pl__all" href="/2015/10/30/iOS-UIKit-Dynamics.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（二）UIKit力学行为</span><span class="pl__date">15/10/30</span></a>
    
      <a class="iOS pl__all" href="/2015/10/30/iOS-Animation-UIViewAndCoreAnimation.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（一）UIView动画和CoreAnimation</span><span class="pl__date">15/10/30</span></a>
    
      <a class="专题 pl__all" href="/2015/10/29/iOS-animation-0.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效专题（零）- 大纲和计划</span><span class="pl__date">15/10/29</span></a>
    
      <a class="iOS pl__all" href="/2015/10/17/ios-webView.html"><span class="pl__circle"></span><span class="pl__title">UIWebView和WKWebView的使用及js交互</span><span class="pl__date">15/10/17</span></a>
    
      <a class="iOS pl__all" href="/2015/10/06/ios-swift-quick.html"><span class="pl__circle"></span><span class="pl__title">swift5分钟语法速记</span><span class="pl__date">15/10/06</span></a>
    
      <a class="iOS pl__all" href="/2015/09/20/ios-macro.html"><span class="pl__circle"></span><span class="pl__title">ios宏的使用和技巧</span><span class="pl__date">15/09/20</span></a>
    
      <a class="iOS pl__all" href="/2015/09/11/ios-BLE-4.html"><span class="pl__circle"></span><span class="pl__title">ios蓝牙开发（四）BabyBluetooth蓝牙库介绍</span><span class="pl__date">15/09/11</span></a>
    
      <a class="iOS pl__all" href="/2015/09/07/ios-BLE-3.html"><span class="pl__circle"></span><span class="pl__title">ios蓝牙开发（三）app作为外设被连接的实现</span><span class="pl__date">15/09/07</span></a>
    
      <a class="iOS pl__all" href="/2015/09/02/ios-draw-Graffiti-2.html"><span class="pl__circle"></span><span class="pl__title">ios绘图demo,做一个涂鸦板(下)</span><span class="pl__date">15/09/02</span></a>
    
      <a class="web前端 pl__all" href="/2015/08/29/go-deep-into-unsilder.js.html"><span class="pl__circle"></span><span class="pl__title">深入理解unslider.js源码</span><span class="pl__date">15/08/29</span></a>
    
      <a class="生活 pl__all" href="/2015/08/23/life-keyboardAndHHKB.html"><span class="pl__circle"></span><span class="pl__title">键盘那些事，hhkb开箱</span><span class="pl__date">15/08/23</span></a>
    
      <a class="技术 pl__all" href="/2015/08/22/github-ImagesUploadWebSite.html"><span class="pl__circle"></span><span class="pl__title">自己markdown博客的图床程序</span><span class="pl__date">15/08/22</span></a>
    
      <a class="iOS pl__all" href="/2015/08/19/ios-ThreadAndAsynchronization.html"><span class="pl__circle"></span><span class="pl__title">ios的线程和同步异步操作</span><span class="pl__date">15/08/19</span></a>
    
      <a class="iOS pl__all" href="/2015/08/14/ios-BLE-2.html"><span class="pl__circle"></span><span class="pl__title">ios蓝牙开发（二）ios连接外设的代码实现</span><span class="pl__date">15/08/14</span></a>
    
      <a class="iOS pl__all" href="/2015/07/26/ios-draw-Graffiti.html"><span class="pl__circle"></span><span class="pl__title">ios绘图demo,做一个涂鸦板(上)</span><span class="pl__date">15/07/26</span></a>
    
      <a class="iOS pl__all" href="/2015/07/25/ios-draw-base.html"><span class="pl__circle"></span><span class="pl__title">ios绘图基础</span><span class="pl__date">15/07/25</span></a>
    
      <a class="iOS pl__all" href="/2015/07/17/ios-BLE-1.html"><span class="pl__circle"></span><span class="pl__title">iOS蓝牙开发（一）蓝牙相关基础知识</span><span class="pl__date">15/07/17</span></a>
    
      <a class="专题 pl__all" href="/2015/07/17/ios-BLE-0.html"><span class="pl__circle"></span><span class="pl__title">iOS蓝牙的开发专题</span><span class="pl__date">15/07/17</span></a>
    
      <a class="技术 pl__all" href="/2015/07/07/mybatis.html"><span class="pl__circle"></span><span class="pl__title">MyBatis简单使用的demo</span><span class="pl__date">15/07/07</span></a>
    
      <a class="技术 pl__all" href="/2015/07/06/rabbitmq.html"><span class="pl__circle"></span><span class="pl__title">RabbitMQ使用</span><span class="pl__date">15/07/06</span></a>
    
      <a class="iOS pl__all" href="/2015/06/14/ios-library-masonry.html"><span class="pl__circle"></span><span class="pl__title">Masonry的使用</span><span class="pl__date">15/06/14</span></a>
    
      <a class="专题 pl__all" href="/2015/06/14/ios-library-0.html"><span class="pl__circle"></span><span class="pl__title">iOS中那些好用的第三方库</span><span class="pl__date">15/06/14</span></a>
    
      <a class="iOS pl__all" href="/2015/05/29/ios-develop-tool.html"><span class="pl__circle"></span><span class="pl__title">提高iOS开发效率的工具</span><span class="pl__date">15/05/29</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-4.html"><span class="pl__circle"></span><span class="pl__title">Spring 文件上传</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-3.html"><span class="pl__circle"></span><span class="pl__title">Spring- Hibernate数据基本操作</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-2.html"><span class="pl__circle"></span><span class="pl__title">Spring RestController 请求参数详解</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-1.html"><span class="pl__circle"></span><span class="pl__title">Spring和hibernate的maven配置</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/tomcat-domain-name.html"><span class="pl__circle"></span><span class="pl__title">tomcat部署绑定多个域名</span><span class="pl__date">15/05/28</span></a>
    
      <a class="专题 pl__all" href="/2015/05/28/spring-0.html"><span class="pl__circle"></span><span class="pl__title">Spring4+hibernate专题</span><span class="pl__date">15/05/28</span></a>
    
      <a class="web前端 pl__all" href="/2015/04/29/css-selector.html"><span class="pl__circle"></span><span class="pl__title">css选择器的用法</span><span class="pl__date">15/04/29</span></a>
    
      <a class="技术 pl__all" href="/2014/02/12/how-to-deploy-a-blog-on-github-by-jekyll.html"><span class="pl__circle"></span><span class="pl__title">在Github上搭建Jekyll博客和创建主题</span><span class="pl__date">14/02/12</span></a>
    
      <a class="技术 pl__all" href="/2013/04/23/opensource-licenses.html"><span class="pl__circle"></span><span class="pl__title">五中常见的开源协议整理(BSD,Apache,GPL,LGPL,MIT)</span><span class="pl__date">13/04/23</span></a>
    
    </nav>
  </div> <!-- end #posts-list -->
</aside> <!-- end #sidebar -->
    <div id="post">
      <div id="pjax">
        <article id="post__content">
    <h1 id="post__title" data-identifier="20160403">iOS JavaScriptCore使用</h1>
    <p>JavaScriptCore是iOS7引入的新功能，JavaScriptCore可以理解为一个浏览器的运行内核，使用JavaScriptCore可以使用native代码（这里主要指objectiveC和swift）与js代码进行相互的调用，本文主要从几个方面进行了解。</p>

<ul>
  <li>native调用js代码</li>
  <li>js调用native代码</li>
  <li>异常处理</li>
  <li>JavaScriptCore和webView的结合使用</li>
</ul>

<p>要使用JavaScriptCore，首先我们需要引入它的头文件 ` #import &lt;JavaScriptCore/JavaScriptCore.h&gt; `</p>

<p>这个头里面引入了几个重要的对象</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#import "JSContext.h"
#import "JSValue.h"
#import "JSManagedValue.h"
#import "JSVirtualMachine.h"
#import "JSExport.h"
</code></pre></div></div>

<ul>
  <li>JSContext是JavaScript的运行上下文，他主要作用是执行js代码和注册native方法接口</li>
  <li>JSValue是JSContext执行后的返回结果，他可以是任何js类型（比如基本数据类型和函数类型，对象类型等），并且都有对象的方法转换为native对象。</li>
  <li>JSManagedValue是JSValue的封装，用它可以解决js和原声代码之间循环引用的问题</li>
  <li>JSVirtualMachine 管理JS运行时和管理js暴露的native对象的内存</li>
  <li>JSExport是一个协议，通过实现它可以完成把一个native对象暴漏给js</li>
</ul>

<h2 id="native调用js代码">native调用js代码</h2>

<p>先看下面常见的三种情况，之间执行js代码、执行文件或网络中的js代码、注册js方法再利用JSValue调用</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//直接执行js代码</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">evaluateScript</span> <span class="p">{</span>
    <span class="c1">//定义一个js并执行函数</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">exeFunction1</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"function hi(){ return 'hi' }; hi()"</span><span class="p">];</span>
    <span class="c1">//执行一个闭包js</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">exeFunction2</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"(function(){ return 'hi' })()"</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">//执行一段js文件中的代码</span>
<span class="c1">//更多的应用场景使用网络或者本地文件加载一段js代码，充分利用其灵活性</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">evaluateScriptFromJSFile</span> <span class="p">{</span>
    <span class="n">NSString</span> <span class="o">*</span> <span class="n">path</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSBundle</span> <span class="nf">mainBundle</span><span class="p">]</span> <span class="nf">pathForResource</span><span class="p">:</span><span class="s">@"core"</span> <span class="nf">ofType</span><span class="p">:</span><span class="s">@"js"</span><span class="p">];</span>
    <span class="n">NSString</span> <span class="o">*</span> <span class="n">html</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSString</span> <span class="nf">stringWithContentsOfFile</span><span class="p">:</span><span class="n">path</span> <span class="nf">encoding</span><span class="p">:</span><span class="n">NSUTF8StringEncoding</span> <span class="n">error</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">constructor</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="n">html</span><span class="p">];</span>
<span class="p">}</span>

<span class="c1">//注册js方法，然后在利用JSValue调用</span>
<span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">regiestJSFunction</span> <span class="p">{</span>
    <span class="c1">//注册一个函数</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"var hello = function(){ return 'hello' }"</span><span class="p">];</span>
    <span class="c1">//调用</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">value1</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"hello()"</span><span class="p">];</span>
    
    <span class="c1">//注册一个匿名函数</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">jsFunction</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@" (function(){ return 'hello objc' })"</span><span class="p">];</span>
    <span class="c1">//调用</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">value2</span> <span class="o">=</span> <span class="p">[</span><span class="n">jsFunction</span> <span class="nf">callWithArguments</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
<span class="p">}</span>

</code></pre></div></div>

<p>这里有几个重要的地方需要说明。</p>

<h3 id="jscontext执行evaluatescript方法后的返回值类型">jsContext执行evaluateScript方法后的返回值类型</h3>

<p>对于native来说，返回的类型都是JSValue，这是Native对js执行对象的统一封装类型，实际上他对应的js类型不同会导致它的使用方法也不相同，常见的类型比如返回数值类型和返回一个函数。</p>

<p>如果是返回数值类型，JSValue也对应了一组转换的API可以把JSValue转换成任何对于的native对象，例如：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="n">NSArray</span> <span class="o">*</span><span class="p">)</span><span class="n">toArray</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSDictionary</span> <span class="o">*</span><span class="p">)</span><span class="n">toDictionary</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSDate</span> <span class="o">*</span><span class="p">)</span><span class="n">toDate</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">toString</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSNumber</span> <span class="o">*</span><span class="p">)</span><span class="n">toNumber</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">toUInt32</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="n">toObject</span><span class="p">;</span>
<span class="p">...</span> <span class="err">还有很多就不一一列举</span>
</code></pre></div></div>

<p>如果返回的是一个函数类型，这可以使用 ` jsvalue callWithArguments `方法进行js函数调用，例如：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="c1">//注册一个匿名函数</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">jsFunction</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@" (function() { return 'hello objc' })"</span><span class="p">];</span>
    <span class="c1">//调用</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">value2</span> <span class="o">=</span> <span class="p">[</span><span class="n">jsFunction</span> <span class="nf">callWithArguments</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</code></pre></div></div>

<p>js是非常美妙的，主要这里的js是一段闭包代码，主要看下面两段代码的区别</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">'hello objc'</span> <span class="p">})</span>
<span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="s1">'hello objc'</span> <span class="p">}</span>
</code></pre></div></div>

<p>第一行是一个闭包，在js中执行这段代码会返回一个函数，而第二行是定义一个函数，执行第二行的结果是定义了一个匿名函数，但是执行结果无返回值。</p>

<p>所以执行下面这段代码时省略了<code class="highlighter-rouge">()</code>，那么jsFunction的值就会为空了，很多移动端研发工程师不熟悉js代码很容易出现这样的错误。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   JSValue *jsFunction = [self.jsContext evaluateScript:@" (function() { return 'hello objc' })"];
</code></pre></div></div>

<p>当然如果我们在运行时中定义一个函数，后面也是可以调用的，只是不是使用callWithArguments方法了，示例如下：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"var hello = function(){ return 'hello' }"</span><span class="p">];</span>
  <span class="n">JSValue</span> <span class="o">*</span><span class="n">value1</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"hello()"</span><span class="p">];</span>
</code></pre></div></div>

<p>执行后的结果就是value1或得到一个string类型的值：“hello”</p>

<h2 id="js调用native代码">js调用native代码</h2>

<p>js调用native代码之前需要native先注册接口，使用jsContext[“方法名”]就可以注册，后面是一个闭包，闭包可以定义函数参数，也可以使用 <code class="highlighter-rouge">[JSContext currentArguments]</code> 方法获取到所有函数调用的参数</p>

<p>看一段例子：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//注册js方法给Native调用</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">regiestNativeFunction</span> <span class="p">{</span>
    <span class="c1">//注册一个objc方法给js调用</span>
    <span class="n">self</span><span class="p">.</span><span class="n">jsContext</span><span class="p">[</span><span class="s">@"log"</span><span class="p">]</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="n">msg</span><span class="p">){</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"js:msg:%@"</span><span class="p">,</span><span class="n">msg</span><span class="p">);</span>
    <span class="p">};</span>
    <span class="c1">//另一种方式，利用currentArguments获取参数</span>
    <span class="n">self</span><span class="p">.</span><span class="n">jsContext</span><span class="p">[</span><span class="s">@"log"</span><span class="p">]</span> <span class="o">=</span> <span class="o">^</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">JSContext</span> <span class="nf">currentArguments</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="n">obj</span> <span class="k">in</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span> <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span><span class="n">obj</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">};</span>
    
    <span class="c1">//使用js调用objc</span>
    <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"log('hello,i am js side')"</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>block使用仍然需要注意循环引用的问题，所以在block中可以使用JSContext的静态方法 ` + (JSContext *)currentContext ` 获取到context</p>

<p>初次之外，JSContext还可以获取到更多的内容，比如：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>currentCallee
currentThis
currentArguments
globalObject
</code></pre></div></div>

<p>callee和this都是js中的对象，callee简单的说就是调用函数的对象，this类似于native中的self。</p>

<p>当然，jsContext中下标不仅仅可以放函数，也可以放对象和数值，对于熟悉js代码的人也不会觉得奇怪，因为js中基本上不太区分对象，函数的概念，对象和函数都是一样的东西。</p>

<p>除了使用jsContext下标方法暴露js对象以外，还可以使用JSExprot协议去把objc复杂对象转换成JSValue并暴露给js对象</p>

<h3 id="jsexport对象的用法">JSExport对象的用法</h3>

<p>1: 首先自定义个协议继承自JSExprot，并定义需要暴露给js的属性和方法，比如：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@protocol</span> <span class="nc">JSPersonProtocol</span> <span class="o">&lt;</span><span class="n">JSExport</span><span class="o">&gt;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span> <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">whatYouName</span><span class="p">;</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>2: 新建一个native对象，实现协议和方法,比如：</p>

<p>.h</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">@interface</span> <span class="nc">Person</span> <span class="p">:</span> <span class="nc">NSObject</span><span class="o">&lt;</span><span class="n">JSPersonProtocol</span><span class="o">&gt;</span>

<span class="k">@property</span> <span class="p">(</span><span class="n">nonatomic</span><span class="p">,</span> <span class="n">copy</span><span class="p">)</span><span class="n">NSString</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">whatYouName</span><span class="p">;</span>

<span class="k">@end</span>

</code></pre></div></div>

<p>.m</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#import "Person.h"
</span>
<span class="k">@implementation</span> <span class="nc">Person</span>

<span class="k">-</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">whatYouName</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">@"my name is liuyanwei"</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">-</span><span class="p">(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="n">name</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">@"liuyanwei"</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">@end</span>
</code></pre></div></div>

<p>使用</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">useJSExprot</span> <span class="p">{</span>
    <span class="n">Person</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">[[</span><span class="n">Person</span> <span class="nf">alloc</span><span class="p">]</span><span class="nf">init</span><span class="p">];</span>
    <span class="n">self</span><span class="p">.</span><span class="n">jsContext</span><span class="p">[</span><span class="s">@"person"</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">JSValue</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">self</span><span class="p">.</span><span class="n">jsContext</span> <span class="nf">evaluateScript</span><span class="p">:</span><span class="s">@"person.whatYouName()"</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>

<p>执行后的结果就是，value的值为：my name is liuyanwei</p>

<h2 id="异常处理">异常处理</h2>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//注册js错误处理</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">jsExceptionHandler</span> <span class="p">{</span>
    <span class="n">self</span><span class="p">.</span><span class="n">jsContext</span><span class="p">.</span><span class="n">exceptionHandler</span> <span class="o">=</span> <span class="o">^</span><span class="p">(</span><span class="n">JSContext</span> <span class="o">*</span><span class="n">con</span><span class="p">,</span> <span class="n">JSValue</span> <span class="o">*</span><span class="n">exception</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"%@"</span><span class="p">,</span> <span class="n">exception</span><span class="p">);</span>
        <span class="n">con</span><span class="p">.</span><span class="n">exception</span> <span class="o">=</span> <span class="n">exception</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="javascriptcore和uiwebview的结合使用">JavaScriptCore和UIWebView的结合使用</h2>

<p>上面的代码都是基于JSContext的，如果声明了一个UIWebView，也可以使用UIWebView获取到JSContext对象，就可以使用JavaScriptCore的Api了，在UIWebView中获取JSContext的方法是：</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">JSContext</span> <span class="o">*</span><span class="n">context</span><span class="o">=</span><span class="p">[</span><span class="n">webView</span> <span class="nf">valueForKeyPath</span><span class="p">:</span><span class="s">@"documentView.webView.mainFrame.javaScriptContext"</span><span class="p">];</span>
</code></pre></div></div>

<p>不过遗憾的是WKWebView目前我还没有找到获取JSContext的方法，如果有知道的朋友也希望能联系我。</p>

<h2 id="jsvirtualmachine">JSVirtualMachine</h2>

<p>在创建jscontext的时候，可以传入一个JSVirtualMachine对象，如果没有传入这个对象，会新建一个JSVirtualMachine对象。</p>

<p>JSVirtualMachine主要有3个作用：</p>

<p>1: 支持js并发，多个VM之间的js操作是并发的
1：使用JSVirtualMachine初始化的多个context，可以共享jsvalue对象
2：解决循环引用问题</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>注意，当我们 export 一个 OC 或 Swift object 到 JS 中时，不能在这个object 中存储对应的 JS values。这种行为会导致一个retain cycle，JSValue objects 持有他们对应的 JSContext 的强引用，JSContext 则持有export到JS的native object的强引用，即 native object(OC or Swift object) —&gt; JSValue —&gt; JSContext —&gt; native object
</code></pre></div></div>

<h2 id="参考">参考</h2>

<ul>
  <li><a href="http://blog.csdn.net/colorapp/article/details/51059645">JavaScriptCore学习之JavaScriptCore</a></li>
  <li><a href="http://blog.iderzheng.com/introduction-to-ios7-javascriptcore-framework/">iOS7新JavaScriptCore框架入门介绍</a>
    <h2 id="demo">demo</h2>
  </li>
</ul>

<p><a href="https://github.com/coolnameismy/demo/tree/master/JavaScriptCore">本文的demo下载</a></p>

<p>感谢收看，如果对大家有帮助，请<a href="https://github.com/coolnameismy">github上follow和star</a>，本文发布在<a href="https://zsmsimon.github.io/">刘彦玮的技术博客</a>，转载请注明出处</p>

    <div class="declare">
        <div>

        </div>
    </div>
</article>
<!-- end #post__content -->

<div id="post__share">
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=http://localhost:4000/2016/04/03/iOS-JavaScriptCore.html&text=iOS JavaScriptCore使用" target="_blank"></a>
  <a id="icon-cc" class="fontello" href="http://github.com/ZSMSimon" target="_blank"></a>
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=http://localhost:4000/2016/04/03/iOS-JavaScriptCore.html&title=iOS JavaScriptCore使用" target="_blank"></a>
    <!-- <div class="share-info">分享一下~</div> -->
</div>
<div id="qrcode" >
	<img src="http://localhost:4000/assets/images/qrcode.jpg" style="margin: 0 auto;display: block;" width="200" height="200" alt="">
</div>
<!-- end #post__share -->
<div id="disqus_thread" name="coolnameismy">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank">Loading Disqus comments...</a>
</div>


            <!---->
    <!--<p id="copyright">Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>-->
    <!--&nbsp;&nbsp;|&nbsp;&nbsp;Theme <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll</a>-->
    <!--&nbsp;&nbsp;|&nbsp;&nbsp;Hosted on <a href="https://pages.github.com" target="_blank">Github</a></p>-->
      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">Table of Contents</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div> <!-- end #post -->

    <button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>

<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.pjax.js"></script>
<script src="/assets/js/nprogress.js"></script>
<script src="/assets/js/searchbox.js"></script>
<script src="/assets/js/script.js"></script>


    <script>
    //百度站点统计,排除localhost
    if(window.location.host.indexOf("localhost") ==-1 &&  window.location.host.indexOf("127.0.0.1") == -1){

        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?2c1583237ca3f5343d8dab0140019ca7";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }
</script>
   </body>
 </html>