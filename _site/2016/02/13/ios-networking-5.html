<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="baidu-site-verification" content="w9Akh6dPe4" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<!--[if lte IE 8]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

<title>iOS networking（五）网络请求中的cookie | 曾绍明的博客</title>
<meta name="author" content="曾绍明">




<link rel="shortcut icon" href="" />

<link rel="stylesheet" type="text/css" href="/assets/css/style.css">

<link href="/pages/rss.xml" rel="alternate" title="曾绍明的博客" type="application/atom+xml">



  </head>
  <body>
        <aside id="sidebar">
  <nav id="tags">
    <a href="/index.html" id="avatar" style="background-image:url(https://avatars1.githubusercontent.com/u/15245912)"></a>

    <ul id="tags__ul">
      <li id="pl__all" class="tags__li tags-btn active">所有文章</li>
       
        <li id="技术" class="tags__li tags-btn">技术</li>
       
        <li id="web前端" class="tags__li tags-btn">web前端</li>
       
        <li id="专题" class="tags__li tags-btn">专题</li>
       
        <li id="iOS" class="tags__li tags-btn">iOS</li>
       
        <li id="生活" class="tags__li tags-btn">生活</li>
       
        <li id="react-native" class="tags__li tags-btn">react-native</li>
       
        <li id="其他" class="tags__li tags-btn">其他</li>
       
        <li id="IoT" class="tags__li tags-btn">IoT</li>
      
    </ul>

    <div id="tags__bottom">
      <a href="http://github.com/ZSMSimon" id="icon-github" class="tags-btn fontello" target="_blank"></a>
      <a href="/pages/rss.xml" id="icon-feed" class="tags-btn fontello" target="_blank"></a>
      <a href="mailto:ZSMSimon@163.com" id="icon-email" class="tags-btn fontello"></a>
    </div>
  </nav> <!-- end #tags -->

  <div id="posts-list">
    <form action="" id="search-form">
      <a href="/index.html" id="mobile-avatar" style="background-image:url(https://avatars1.githubusercontent.com/u/15245912)"></a>
      <!-- NOTE: input field is disabled by default -->
      <input id="search-input" type="text" placeholder="Search..." >
    </form>

    <nav id="pl__container">
    
      <a class="IoT pl__all" href="/2017/05/16/JavaScript-mqtt-temperaturedemo.html"><span class="pl__circle"></span><span class="pl__title">IoT技术选型及模型设计的思考</span><span class="pl__date">17/05/16</span></a>
    
      <a class="IoT pl__all" href="/2017/05/02/hello-nodemcu.html"><span class="pl__circle"></span><span class="pl__title">hello nodemcu</span><span class="pl__date">17/05/02</span></a>
    
      <a class="其他 pl__all" href="/2017/03/16/Recruitment.html"><span class="pl__circle"></span><span class="pl__title">阿里云iot事业部招聘信息</span><span class="pl__date">17/03/16</span></a>
    
      <a class="技术 pl__all" href="/2017/01/23/zhihu-live-a-hour-for-bluetooth-0.html"><span class="pl__circle"></span><span class="pl__title">知乎live：一小时蓝牙科普 文字整理版</span><span class="pl__date">17/01/23</span></a>
    
      <a class="web前端 pl__all" href="/2016/12/08/eslint-guide.html"><span class="pl__circle"></span><span class="pl__title">ESLint使用</span><span class="pl__date">16/12/08</span></a>
    
      <a class="其他 pl__all" href="/2016/12/06/how-to-fupan.html"><span class="pl__circle"></span><span class="pl__title">柳传志：我的复盘方法论</span><span class="pl__date">16/12/06</span></a>
    
      <a class="react-native pl__all" href="/2016/11/14/react-native-flux%E6%95%B0%E6%8D%AE%E6%B5%81.html"><span class="pl__circle"></span><span class="pl__title">flux数据流在rn中的使用</span><span class="pl__date">16/11/14</span></a>
    
      <a class="专题 pl__all" href="/2016/05/09/iOS-networking-0.html"><span class="pl__circle"></span><span class="pl__title">iOS 网络请求专题</span><span class="pl__date">16/05/09</span></a>
    
      <a class="iOS pl__all" href="/2016/04/03/iOS-JavaScriptCore.html"><span class="pl__circle"></span><span class="pl__title">iOS JavaScriptCore使用</span><span class="pl__date">16/04/03</span></a>
    
      <a class="iOS pl__all" href="/2016/04/02/iOS-3DTouch-3.html"><span class="pl__circle"></span><span class="pl__title">iOS 3D touch开发(三) Force Properties-按压力度</span><span class="pl__date">16/04/02</span></a>
    
      <a class="iOS pl__all" href="/2016/04/01/iOS-3DTouch-2.html"><span class="pl__circle"></span><span class="pl__title">iOS 3D touch开发(二) peek and pop - 预览和弹出</span><span class="pl__date">16/04/01</span></a>
    
      <a class="iOS pl__all" href="/2016/03/21/iOS-3DTouch-1.html"><span class="pl__circle"></span><span class="pl__title">iOS 3D touch开发(一) Home Screen Quick Actions</span><span class="pl__date">16/03/21</span></a>
    
      <a class="iOS pl__all" href="/2016/03/10/iOS-unit-test.html"><span class="pl__circle"></span><span class="pl__title">iOS单元测试</span><span class="pl__date">16/03/10</span></a>
    
      <a class="iOS pl__all" href="/2016/02/29/iOS-objc-styleguide.html"><span class="pl__circle"></span><span class="pl__title">iOS objc编程规范</span><span class="pl__date">16/02/29</span></a>
    
      <a class="iOS pl__all" href="/2016/02/13/ios-networking-5.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（五）网络请求中的cookie</span><span class="pl__date">16/02/13</span></a>
    
      <a class="iOS pl__all" href="/2016/02/09/ios-networking-4.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（四） http异步文件上传和下载以及进度指示</span><span class="pl__date">16/02/09</span></a>
    
      <a class="iOS pl__all" href="/2016/02/04/ios-networking-3.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（三） http异步请求和https认证</span><span class="pl__date">16/02/04</span></a>
    
      <a class="iOS pl__all" href="/2016/02/03/ios-networking-2.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（二） http异步队列请求</span><span class="pl__date">16/02/03</span></a>
    
      <a class="iOS pl__all" href="/2016/02/03/ios-networking-1.html"><span class="pl__circle"></span><span class="pl__title">iOS networking（一） http同步请求</span><span class="pl__date">16/02/03</span></a>
    
      <a class="react-native pl__all" href="/2016/02/02/react-native-demo.html"><span class="pl__circle"></span><span class="pl__title">react-native（二） 自己写的react-native学习demo和整理的tips</span><span class="pl__date">16/02/02</span></a>
    
      <a class="react-native pl__all" href="/2016/01/11/react-native-helloworld.html"><span class="pl__circle"></span><span class="pl__title">react-native（一） hello world</span><span class="pl__date">16/01/11</span></a>
    
      <a class="iOS pl__all" href="/2016/01/06/iOS-app-versions.html"><span class="pl__circle"></span><span class="pl__title">api如何设计才能支撑多个不同版本的app共存</span><span class="pl__date">16/01/06</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/31/playwith-imageToAscii.html"><span class="pl__circle"></span><span class="pl__title">那些好玩的nodejs插件 - 把图片转为ascii</span><span class="pl__date">15/12/31</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/10/fe-componentization.html"><span class="pl__circle"></span><span class="pl__title">前端开发框架 - seajs+handlebars模块化开发</span><span class="pl__date">15/12/10</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/06/fe-nginx-usage.html"><span class="pl__circle"></span><span class="pl__title">mac环境nginx的安装和使用</span><span class="pl__date">15/12/06</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/03/fe-js-handlebars.html"><span class="pl__circle"></span><span class="pl__title">handlerbars的使用及模板预编译</span><span class="pl__date">15/12/03</span></a>
    
      <a class="web前端 pl__all" href="/2015/12/01/fe-engineering-gulp.html"><span class="pl__circle"></span><span class="pl__title">gulp自动构建工具教程</span><span class="pl__date">15/12/01</span></a>
    
      <a class="web前端 pl__all" href="/2015/11/27/fe-environment.html"><span class="pl__circle"></span><span class="pl__title">前端开发工具和环境搭建</span><span class="pl__date">15/11/27</span></a>
    
      <a class="web前端 pl__all" href="/2015/11/26/rem-em-px.html"><span class="pl__circle"></span><span class="pl__title">css3属性rem的使用</span><span class="pl__date">15/11/26</span></a>
    
      <a class="生活 pl__all" href="/2015/11/26/mylift-github.html"><span class="pl__circle"></span><span class="pl__title">我每天都在github上做些什么</span><span class="pl__date">15/11/26</span></a>
    
      <a class="iOS pl__all" href="/2015/11/24/iOS-affine-transfermation-animation.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（七）仿射变换-CGAffineTransform</span><span class="pl__date">15/11/24</span></a>
    
      <a class="iOS pl__all" href="/2015/11/22/iOS-library-spring.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（六）swift动画库spring使用和代码拆解</span><span class="pl__date">15/11/22</span></a>
    
      <a class="iOS pl__all" href="/2015/11/16/iOS-Implicit-Animation.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（五）layer隐式动画</span><span class="pl__date">15/11/16</span></a>
    
      <a class="iOS pl__all" href="/2015/11/06/iOS-controller-transitioning.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（四）controller间的自定义过渡效果</span><span class="pl__date">15/11/06</span></a>
    
      <a class="iOS pl__all" href="/2015/11/01/iOS-MotionEffects.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（三）MotionEffects</span><span class="pl__date">15/11/01</span></a>
    
      <a class="iOS pl__all" href="/2015/10/30/iOS-UIKit-Dynamics.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（二）UIKit力学行为</span><span class="pl__date">15/10/30</span></a>
    
      <a class="iOS pl__all" href="/2015/10/30/iOS-Animation-UIViewAndCoreAnimation.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效（一）UIView动画和CoreAnimation</span><span class="pl__date">15/10/30</span></a>
    
      <a class="专题 pl__all" href="/2015/10/29/iOS-animation-0.html"><span class="pl__circle"></span><span class="pl__title">iOS动画和特效专题（零）- 大纲和计划</span><span class="pl__date">15/10/29</span></a>
    
      <a class="iOS pl__all" href="/2015/10/17/ios-webView.html"><span class="pl__circle"></span><span class="pl__title">UIWebView和WKWebView的使用及js交互</span><span class="pl__date">15/10/17</span></a>
    
      <a class="iOS pl__all" href="/2015/10/06/ios-swift-quick.html"><span class="pl__circle"></span><span class="pl__title">swift5分钟语法速记</span><span class="pl__date">15/10/06</span></a>
    
      <a class="iOS pl__all" href="/2015/09/20/ios-macro.html"><span class="pl__circle"></span><span class="pl__title">ios宏的使用和技巧</span><span class="pl__date">15/09/20</span></a>
    
      <a class="iOS pl__all" href="/2015/09/11/ios-BLE-4.html"><span class="pl__circle"></span><span class="pl__title">ios蓝牙开发（四）BabyBluetooth蓝牙库介绍</span><span class="pl__date">15/09/11</span></a>
    
      <a class="iOS pl__all" href="/2015/09/07/ios-BLE-3.html"><span class="pl__circle"></span><span class="pl__title">ios蓝牙开发（三）app作为外设被连接的实现</span><span class="pl__date">15/09/07</span></a>
    
      <a class="iOS pl__all" href="/2015/09/02/ios-draw-Graffiti-2.html"><span class="pl__circle"></span><span class="pl__title">ios绘图demo,做一个涂鸦板(下)</span><span class="pl__date">15/09/02</span></a>
    
      <a class="web前端 pl__all" href="/2015/08/29/go-deep-into-unsilder.js.html"><span class="pl__circle"></span><span class="pl__title">深入理解unslider.js源码</span><span class="pl__date">15/08/29</span></a>
    
      <a class="生活 pl__all" href="/2015/08/23/life-keyboardAndHHKB.html"><span class="pl__circle"></span><span class="pl__title">键盘那些事，hhkb开箱</span><span class="pl__date">15/08/23</span></a>
    
      <a class="技术 pl__all" href="/2015/08/22/github-ImagesUploadWebSite.html"><span class="pl__circle"></span><span class="pl__title">自己markdown博客的图床程序</span><span class="pl__date">15/08/22</span></a>
    
      <a class="iOS pl__all" href="/2015/08/19/ios-ThreadAndAsynchronization.html"><span class="pl__circle"></span><span class="pl__title">ios的线程和同步异步操作</span><span class="pl__date">15/08/19</span></a>
    
      <a class="iOS pl__all" href="/2015/08/14/ios-BLE-2.html"><span class="pl__circle"></span><span class="pl__title">ios蓝牙开发（二）ios连接外设的代码实现</span><span class="pl__date">15/08/14</span></a>
    
      <a class="iOS pl__all" href="/2015/07/26/ios-draw-Graffiti.html"><span class="pl__circle"></span><span class="pl__title">ios绘图demo,做一个涂鸦板(上)</span><span class="pl__date">15/07/26</span></a>
    
      <a class="iOS pl__all" href="/2015/07/25/ios-draw-base.html"><span class="pl__circle"></span><span class="pl__title">ios绘图基础</span><span class="pl__date">15/07/25</span></a>
    
      <a class="iOS pl__all" href="/2015/07/17/ios-BLE-1.html"><span class="pl__circle"></span><span class="pl__title">iOS蓝牙开发（一）蓝牙相关基础知识</span><span class="pl__date">15/07/17</span></a>
    
      <a class="专题 pl__all" href="/2015/07/17/ios-BLE-0.html"><span class="pl__circle"></span><span class="pl__title">iOS蓝牙的开发专题</span><span class="pl__date">15/07/17</span></a>
    
      <a class="技术 pl__all" href="/2015/07/07/mybatis.html"><span class="pl__circle"></span><span class="pl__title">MyBatis简单使用的demo</span><span class="pl__date">15/07/07</span></a>
    
      <a class="技术 pl__all" href="/2015/07/06/rabbitmq.html"><span class="pl__circle"></span><span class="pl__title">RabbitMQ使用</span><span class="pl__date">15/07/06</span></a>
    
      <a class="iOS pl__all" href="/2015/06/14/ios-library-masonry.html"><span class="pl__circle"></span><span class="pl__title">Masonry的使用</span><span class="pl__date">15/06/14</span></a>
    
      <a class="专题 pl__all" href="/2015/06/14/ios-library-0.html"><span class="pl__circle"></span><span class="pl__title">iOS中那些好用的第三方库</span><span class="pl__date">15/06/14</span></a>
    
      <a class="iOS pl__all" href="/2015/05/29/ios-develop-tool.html"><span class="pl__circle"></span><span class="pl__title">提高iOS开发效率的工具</span><span class="pl__date">15/05/29</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-4.html"><span class="pl__circle"></span><span class="pl__title">Spring 文件上传</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-3.html"><span class="pl__circle"></span><span class="pl__title">Spring- Hibernate数据基本操作</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-2.html"><span class="pl__circle"></span><span class="pl__title">Spring RestController 请求参数详解</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/spring-1.html"><span class="pl__circle"></span><span class="pl__title">Spring和hibernate的maven配置</span><span class="pl__date">15/05/28</span></a>
    
      <a class="技术 pl__all" href="/2015/05/28/tomcat-domain-name.html"><span class="pl__circle"></span><span class="pl__title">tomcat部署绑定多个域名</span><span class="pl__date">15/05/28</span></a>
    
      <a class="专题 pl__all" href="/2015/05/28/spring-0.html"><span class="pl__circle"></span><span class="pl__title">Spring4+hibernate专题</span><span class="pl__date">15/05/28</span></a>
    
      <a class="web前端 pl__all" href="/2015/04/29/css-selector.html"><span class="pl__circle"></span><span class="pl__title">css选择器的用法</span><span class="pl__date">15/04/29</span></a>
    
      <a class="技术 pl__all" href="/2014/02/12/how-to-deploy-a-blog-on-github-by-jekyll.html"><span class="pl__circle"></span><span class="pl__title">在Github上搭建Jekyll博客和创建主题</span><span class="pl__date">14/02/12</span></a>
    
      <a class="技术 pl__all" href="/2013/04/23/opensource-licenses.html"><span class="pl__circle"></span><span class="pl__title">五中常见的开源协议整理(BSD,Apache,GPL,LGPL,MIT)</span><span class="pl__date">13/04/23</span></a>
    
    </nav>
  </div> <!-- end #posts-list -->
</aside> <!-- end #sidebar -->
    <div id="post">
      <div id="pjax">
        <article id="post__content">
    <h1 id="post__title" data-identifier="20160213">iOS networking（五）网络请求中的cookie</h1>
    <blockquote>
  <p>本篇主要介绍客户端和服务端对cookie的操作</p>
</blockquote>

<h2 id="服务端代码">服务端代码</h2>
<hr />

<pre><code class="language-JavaScript">
    //设置cookie
	function cookie(req,res){
		//打印客户端的cookie
		console.log("client cookie:"+req.headers.cookie);

		var today = new Date();
		var time = today.getTime() + 60*1000;
		var time2 = new Date(time);
		var timeObj = time2.toGMTString();

        //给f的值添加了一个过期时间的参数
	    res.setHeader("Set-Cookie", ['d=001;maxAge=10*1000', 'e=1112', 'f=2222;Expires='+timeObj]);

		var msg = { "status":1,"msg":"succeed"}
		res.write(JSON.stringify(msg));
		res.end();
	}

</code></pre>

<p>这段代码主要有2个地方需要注意，一是服务端设置cookie并返回到客户端，一个是服务端获取客户端上传的cookie</p>

<h3 id="服务端设置cookie">服务端设置cookie</h3>
<blockquote>
  <p>服务端设置主要是通过在相应头中设置Set-Cookie，可以使用 <code class="highlighter-rouge">response.writeHead</code> 或是 <code class="highlighter-rouge">response.setHeader</code>方法设置</p>
</blockquote>

<p>cookie的设置的一般格式：</p>

<p>单个</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Set-Cookie:
            cookieName=cookieValue;
            [expires=]
            [;domain=]
            [;path=]
            [;secure=]
            [;httpOnly=]
</code></pre></div></div>

<p>多个</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    Set-Cookie:'[cookie1,cookie2];
</code></pre></div></div>

<p>参数说明：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1、expires：指定过期时间，以GMT格式表示的时间字符串，如方法一个的“timeObj”。
2、maxAge：指定过期时间，同expires（expires和maxAge选两者其一设值即可）。和expires不同之处在于，maxAge值的单位为毫秒（见方法二中的maxAge:10*1000，即为10秒）。maxAge值可以是正数和负数。正数表示当前COOKIE存活的时间。负数表示当前COOKIE只是随着浏览器存储在客户端的内存里，只要关闭浏览器，此COOKIE就马上消失。默认值为-1。
3、domain：指定可访问COOKIE的主机名。主机名是指同一个域名下的不同主机。如：www.google.com和gmail.google.com是在两个不同的主机上，即两个不同的主机名。默认情况下，一个主机中创建的COOKIE在另一个主机下是不能被访问，但可以通过domain参数来实现对其的控制，即所谓的跨子域。以google为例，要实现跨主机（跨子域）访问，写法如下：domain=.google.com，这样就实现了所有google.com下的主机都可以访问此COOKIE。（本机环境上设置此值时，COOKIE无法查看。）
4、path：指定可访问此COOKIE的目录。如：path=/default  表示当前COOKIE仅能在 default 目录下使用。默认值为“/”，即根目录下的所有目录皆可以访问。
5、secure：当设为true时，表示创建的COOKIE会以安全的形式向服务器传输，即只能在HTTPS连接中被浏览器传递到服务器端进行会话验证；若是HTTP连接则不会传递该信息，所以不会被窃取到COOKIE里的具体内容。同理，在客户端，我们也无法使用document.cookie找到被设置了secure=true的cookie健值对。secure属性是防止信息在传递的过程中被监听捕获后信息泄漏，httpOnly属性的目的是防止程序获取COOKIE后进行攻击（XSS）。我们可以把secure=true看成比httpOnly=true是更严格的访问控制。
6、httpOnly：是微软对COOKIE做的扩展。如果在COOKIE中设置了“httpOnly”属性，则通过程序（JS脚本、applet等）将无法读取到COOKIE信息，防止XSS攻击产生。
</code></pre></div></div>

<h3 id="服务端设置cookie的例子">服务端设置cookie的例子：</h3>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//例子1</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">"Set-Cookie"</span><span class="p">,</span> <span class="p">[</span><span class="s1">'a=001'</span><span class="p">,</span> <span class="s1">'b=1112'</span><span class="p">,</span> <span class="s1">'c=2222'</span><span class="p">]);</span>

<span class="c1">//例子2 设置过期时间</span>
<span class="kd">var</span> <span class="nx">today</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">time</span> <span class="o">=</span> <span class="nx">today</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="mi">60</span><span class="o">*</span><span class="mi">1000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">time2</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">time</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">timeObj</span> <span class="o">=</span> <span class="nx">time2</span><span class="p">.</span><span class="nx">toGMTString</span><span class="p">();</span>
 <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">"Set-Cookie"</span><span class="p">,</span> <span class="p">[</span><span class="s1">'d=001'</span><span class="p">,</span> <span class="s1">'e=1112'</span><span class="p">,</span> <span class="s1">'f=2222;Expires='</span><span class="o">+</span><span class="nx">timeObj</span><span class="p">,]);</span>

<span class="c1">//例子3：</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">,{</span>
    <span class="s1">'Content-type'</span><span class="p">:</span><span class="s1">'text/json'</span><span class="p">,</span>
    <span class="s2">"Set-Cookie"</span><span class="p">:[</span><span class="s1">'a=001'</span><span class="p">,</span> <span class="s1">'b=1112'</span><span class="p">,</span> <span class="s1">'c=2222'</span><span class="p">]</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="服务端获取客户端cookie">服务端获取客户端cookie</h3>

<pre><code class="language-JavaScript">//打印客户端的cookie
console.log("client cookie:"+req.headers.cookie);
</code></pre>

<h3 id="服务端删除或修改cookie">服务端删除或修改cookie</h3>

<p>删除和修改cookie本质都是一样的，把原来存在的cookie设为空值，就是删除，设为其他的值就是修改，服务端也有封装好的cookie库，
我们这里的方法都是最底层的htpp模块的方法。</p>

<h2 id="客户端ios-操作cookie">客户端iOS 操作cookie</h2>
<hr />

<h3 id="获取服务端返回的cookie">获取服务端返回的cookie</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
    <span class="c1">//获取cookie</span>
    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">headers</span> <span class="o">=</span> <span class="p">[((</span><span class="n">NSHTTPURLResponse</span> <span class="o">*</span><span class="p">)</span><span class="n">resp</span><span class="p">)</span> <span class="nf">allHeaderFields</span><span class="p">];</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"headers:%@"</span><span class="p">,</span><span class="n">headers</span><span class="p">);</span>
    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">cookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSHTTPCookie</span> <span class="nf">cookiesWithResponseHeaderFields</span><span class="p">:</span><span class="n">headers</span> <span class="nf">forURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="s">@"http://localhost/"</span><span class="p">]];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">NSHTTPCookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="k">in</span> <span class="n">cookies</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"cookie:%@"</span><span class="p">,</span><span class="n">cookie</span><span class="p">);</span>
    <span class="p">}</span>

</code></pre></div></div>

<p>服务端返回的cookie在响应头中，请求上节服务端代码设置cookie的那个路径：http://localhost:8001/cookie 后打印的结果如下：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2016-02-13 18:04:08.611 network-demo[20302:1737476] ====请求开始====
2016-02-13 18:04:08.611 network-demo[20302:1737476] {
    msg = succeed;
    status = 1;
}
2016-02-13 18:04:08.611 network-demo[20302:1737476] ====请求结束====
2016-02-13 18:04:08.611 network-demo[20302:1737476] headers:{
    Connection = "keep-alive";
    Date = "Sat, 13 Feb 2016 10:04:08 GMT";
    "Set-Cookie" = "d=001;maxAge=10*1000, e=1112, f=2222;Expires=Sat, 13 Feb 2016 10:05:08 GMT";
    "Transfer-Encoding" = Identity;
}
2016-02-13 18:04:08.617 network-demo[20302:1737476] cookie:&lt;NSHTTPCookie version:0 name:"d" value:"001" expiresDate:(null) created:2016-02-13 10:04:08 +0000 sessionOnly:TRUE domain:"localhost" path:"/" isSecure:FALSE&gt;
2016-02-13 18:04:08.617 network-demo[20302:1737476] cookie:&lt;NSHTTPCookie version:0 name:"e" value:"1112" expiresDate:(null) created:2016-02-13 10:04:08 +0000 sessionOnly:TRUE domain:"localhost" path:"/" isSecure:FALSE&gt;
2016-02-13 18:04:08.617 network-demo[20302:1737476] cookie:&lt;NSHTTPCookie version:0 name:"f" value:"2222" expiresDate:2016-02-13 10:05:08 +0000 created:2016-02-13 10:04:08 +0000 sessionOnly:FALSE domain:"localhost" path:"/" isSecure:FALSE&gt;

</code></pre></div></div>

<p>可以看到服务端获取了3个cookie，key分别是d,e,f，其中f设置了cookie的过期时间。</p>

<p>客户端cookie会在每次请求中把cookie自动加载到请求头中发送给服务端，
我们已经收到相应的cookie后，再次请求服务端另一个没有设置cookie的url，看看服务端打印出客户端请求头中的cookie</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{ host: 'localhost:8001',
  accept: '*/*',
  cookie: 'd=001; e=1112',
  'user-agent': 'network-demo/1 CFNetwork/758.0.2 Darwin/14.5.0',
  'accept-language': 'en-us',
  'accept-encoding': 'gzip, deflate',
  connection: 'keep-alive' }
/
client cookie:d=001; e=1112
</code></pre></div></div>

<p>可以看到请求头中获取到了cookie： <code class="highlighter-rouge">client cookie:d=001; e=1112</code> 。
但是这里有个问题，我少了一个key为f的cookie，那是因为f的cookie已经过期了。再看之前iOS模拟器打印的过期时间和服务返回的时间有8小时时差，这个应该是
服务端的时间制式和客户端的制式不同导致的吧，已经搞mongodb的时候也遇到过，这里不用纠结这些小问题了，反正就是过期了。</p>

<h3 id="获取客户端存储的cookie">获取客户端存储的cookie</h3>

<p>通过<code class="highlighter-rouge">NSHTTPCookieStorage</code>的单例类就可以获取到之前服务端的cookie</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//获取本地cookie</span>
<span class="n">NSHTTPCookieStorage</span> <span class="o">*</span><span class="n">httpCookiesStorage</span> <span class="o">=</span>  <span class="p">[</span><span class="n">NSHTTPCookieStorage</span> <span class="nf">sharedHTTPCookieStorage</span><span class="p">];</span>
<span class="n">NSDictionary</span> <span class="o">*</span><span class="n">cookies</span> <span class="o">=</span> <span class="p">[</span><span class="n">httpCookiesStorage</span> <span class="nf">cookiesForURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="s">@"http://localhost/"</span><span class="p">]];</span>
<span class="k">for</span> <span class="p">(</span><span class="n">NSHTTPCookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="k">in</span> <span class="n">cookies</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"cookie:%@"</span><span class="p">,</span><span class="n">cookie</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="客户端设置本地cookie">客户端设置本地cookie</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">//客户端设置cookie</span>
<span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">clientSetCookie</span><span class="p">{</span>

    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">prop1</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nf">dictionaryWithObjectsAndKeys</span><span class="p">:</span>
                           <span class="s">@"a"</span><span class="p">,</span><span class="n">NSHTTPCookieName</span><span class="p">,</span>
                           <span class="s">@"aaa"</span><span class="p">,</span><span class="n">NSHTTPCookieValue</span><span class="p">,</span>
                           <span class="s">@"/"</span><span class="p">,</span><span class="n">NSHTTPCookiePath</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="s">@"http://localhost/"</span><span class="p">],</span><span class="n">NSHTTPCookieOriginURL</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">NSDate</span> <span class="nf">dateWithTimeIntervalSinceNow</span><span class="p">:</span><span class="mi">60</span><span class="p">],</span><span class="n">NSHTTPCookieExpires</span><span class="p">,</span>
                           <span class="nb">nil</span><span class="p">];</span>

    <span class="n">NSDictionary</span> <span class="o">*</span><span class="n">prop2</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSDictionary</span> <span class="nf">dictionaryWithObjectsAndKeys</span><span class="p">:</span>
                           <span class="s">@"b"</span><span class="p">,</span><span class="n">NSHTTPCookieName</span><span class="p">,</span>
                           <span class="s">@"bbb"</span><span class="p">,</span><span class="n">NSHTTPCookieValue</span><span class="p">,</span>
                           <span class="s">@"/"</span><span class="p">,</span><span class="n">NSHTTPCookiePath</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="s">@"http://localhost/"</span><span class="p">],</span><span class="n">NSHTTPCookieOriginURL</span><span class="p">,</span>
                           <span class="p">[</span><span class="n">NSDate</span> <span class="nf">dateWithTimeIntervalSinceNow</span><span class="p">:</span><span class="mi">60</span><span class="p">],</span><span class="n">NSHTTPCookieExpires</span><span class="p">,</span>
                           <span class="nb">nil</span><span class="p">];</span>

    <span class="n">NSHTTPCookie</span> <span class="o">*</span><span class="n">cookie1</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSHTTPCookie</span> <span class="nf">cookieWithProperties</span><span class="p">:</span><span class="n">prop1</span><span class="p">];</span>
    <span class="n">NSHTTPCookie</span> <span class="o">*</span><span class="n">cookie2</span> <span class="o">=</span> <span class="p">[</span><span class="n">NSHTTPCookie</span> <span class="nf">cookieWithProperties</span><span class="p">:</span><span class="n">prop2</span><span class="p">];</span>

    <span class="c1">//单个设置</span>
<span class="c1">//    [[NSHTTPCookieStorage sharedHTTPCookieStorage] setCookie:cookie1];</span>
<span class="c1">//    [[NSHTTPCookieStorage sharedHTTPCookieStorage] setCookie:cookie2];</span>

    <span class="c1">//批量设置</span>
    <span class="n">NSArray</span> <span class="o">*</span><span class="n">cookies</span> <span class="o">=</span> <span class="p">@[</span><span class="n">cookie1</span><span class="p">,</span><span class="n">cookie2</span><span class="p">];</span>
    <span class="p">[[</span><span class="n">NSHTTPCookieStorage</span> <span class="nf">sharedHTTPCookieStorage</span><span class="p">]</span><span class="nf">setCookies</span><span class="p">:</span><span class="n">cookies</span> <span class="nf">forURL</span><span class="p">:[</span><span class="n">NSURL</span> <span class="nf">URLWithString</span><span class="p">:</span><span class="s">@"http://localhost/"</span><span class="p">]</span> <span class="n">mainDocumentURL</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>

    <span class="n">NSLog</span><span class="p">(</span><span class="s">@"设置完成"</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>说明：</p>
<ul>
  <li>设置好了之后，下次请求url时会自动带入cookie中的数据</li>
  <li><code class="highlighter-rouge">[NSDate dateWithTimeIntervalSinceNow:60]</code>是设置1分钟后超时</li>
  <li>可以一个个设置也可以使用setCookies批量设置</li>
  <li>mainDocumentURL： The URL of the main HTML document for the top-level frame, if known. Can be nil. This URL is used to determine if the cookie should be accepted if the cookie accept policy is NSHTTPCookieAcceptPolicyOnlyFromMainDocumentDomain</li>
</ul>

<h3 id="删除cookie">删除cookie</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">deleteCookie</span><span class="p">:(</span><span class="n">NSHTTPCookie</span> <span class="o">*</span><span class="p">)</span><span class="nv">cookie</span><span class="p">;</span>
<span class="k">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeCookiesSinceDate</span><span class="p">:(</span><span class="n">NSDate</span> <span class="o">*</span><span class="p">)</span><span class="nv">date</span> <span class="n">NS_AVAILABLE</span><span class="p">(</span><span class="mi">10</span><span class="n">_10</span><span class="p">,</span> <span class="mi">8</span><span class="n">_0</span><span class="p">);</span>
</code></pre></div></div>

<p>我们来示范如何删除cookie</p>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cp">#pragma mark -客户端删除cookie
</span>    <span class="c1">//根据url和name删除cookie</span>
    <span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">deleteCookie</span><span class="p">:(</span><span class="n">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nv">cookieName</span> <span class="nf">url</span><span class="p">:(</span><span class="n">NSURL</span> <span class="o">*</span><span class="p">)</span><span class="nv">url</span><span class="p">{</span>
        <span class="c1">//根据url找到所属的cookie集合</span>
        <span class="n">NSArray</span> <span class="o">*</span><span class="n">cookies</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSHTTPCookieStorage</span> <span class="nf">sharedHTTPCookieStorage</span><span class="p">]</span><span class="nf">cookiesForURL</span><span class="p">:</span><span class="n">url</span><span class="p">];</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">NSHTTPCookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="k">in</span> <span class="n">cookies</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">([</span><span class="n">cookie</span><span class="p">.</span><span class="n">name</span> <span class="nf">isEqualToString</span><span class="p">:</span><span class="n">cookieName</span><span class="p">]){</span>
                <span class="p">[[</span><span class="n">NSHTTPCookieStorage</span> <span class="nf">sharedHTTPCookieStorage</span><span class="p">]</span> <span class="nf">deleteCookie</span><span class="p">:</span><span class="n">cookie</span><span class="p">];</span>
                <span class="n">NSLog</span><span class="p">(</span><span class="s">@"删除cookie:%@"</span><span class="p">,</span><span class="n">cookieName</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">//删除全部cookies</span>
    <span class="k">-</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">deleteCookies</span><span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">NSHTTPCookie</span> <span class="o">*</span><span class="n">cookie</span> <span class="k">in</span> <span class="p">[[</span><span class="n">NSHTTPCookieStorage</span> <span class="nf">sharedHTTPCookieStorage</span><span class="p">]</span><span class="nf">cookies</span><span class="p">])</span> <span class="p">{</span>
            <span class="p">[[</span><span class="n">NSHTTPCookieStorage</span> <span class="nf">sharedHTTPCookieStorage</span><span class="p">]</span> <span class="nf">deleteCookie</span><span class="p">:</span><span class="n">cookie</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="n">NSLog</span><span class="p">(</span><span class="s">@"删除完成"</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div></div>

<h3 id="cookie的本地缓存策略">cookie的本地缓存策略</h3>

<div class="language-objc highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">//设置cookie本地缓存策略</span>
<span class="c1">//NSHTTPCookieAcceptPolicyAlways:保存所有cookie，这个是默认值</span>
<span class="c1">//NSHTTPCookieAcceptPolicyNever:不保存任何响应头中的cookie</span>
<span class="c1">//NSHTTPCookieAcceptPolicyOnlyFromMainDocumentDomain:只保存域请求匹配的cookie</span>
</code></pre></div></div>

<p>我们测试一下效果：
<code class="highlighter-rouge">[[NSHTTPCookieStorage sharedHTTPCookieStorage]setCookieAcceptPolicy:NSHTTPCookieAcceptPolicyNever];</code></p>

<p><img src="http://localhost:4000/assets/uploads/2016-02-13-ios-networking-5_1.png" alt="" /></p>

<p>这样设置之后，调用demo中的 <code class="highlighter-rouge">客户端设置cookie</code> ，在调用<code class="highlighter-rouge">从服务端获取cookie</code>，最后调用<code class="highlighter-rouge">打印客户端cookie</code>，查看日志：</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
</code></pre></div></div>

<p>我们可以看到，客户端没有打印任何cookie，因为设置的策略为：<code class="highlighter-rouge">NSHTTPCookieAcceptPolicyNever</code></p>

<p>我们在修改为<code class="highlighter-rouge">NSHTTPCookieAcceptPolicyAlways 或是 NSHTTPCookieAcceptPolicyOnlyFromMainDocumentDomain</code>，再次测试一次，可以看到，服务端和客户端设置的cookie都会打印出来。这两个选项会针对不同域名返回的cookie做选择性保存。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>2016-02-14 00:59:47.030 network-demo[21191:1810897] cookie:&lt;NSHTTPCookie version:0 name:"a" value:"aaa" expiresDate:2016-02-13 17:00:32 +0000 created:2016-02-13 16:59:32 +0000 sessionOnly:FALSE domain:"localhost" path:"/" isSecure:FALSE&gt;
2016-02-14 00:59:47.030 network-demo[21191:1810897] cookie:&lt;NSHTTPCookie version:0 name:"b" value:"bbb" expiresDate:2016-02-13 17:00:32 +0000 created:2016-02-13 16:59:32 +0000 sessionOnly:FALSE domain:"localhost" path:"/" isSecure:FALSE&gt;
2016-02-14 00:59:47.030 network-demo[21191:1810897] cookie:&lt;NSHTTPCookie version:0 name:"d" value:"001" expiresDate:(null) created:2016-02-13 16:59:38 +0000 sessionOnly:TRUE domain:"localhost" path:"/" isSecure:FALSE&gt;
2016-02-14 00:59:47.031 network-demo[21191:1810897] cookie:&lt;NSHTTPCookie version:0 name:"e" value:"1112" expiresDate:(null) created:2016-02-13 16:59:38 +0000 sessionOnly:TRUE domain:"localhost" path:"/" isSecure:FALSE&gt;
2016-02-14 00:59:47.031 network-demo[21191:1810897] cookie:&lt;NSHTTPCookie version:0 name:"f" value:"2222" expiresDate:2016-02-13 17:00:38 +0000 created:2016-02-13 16:59:38 +0000 sessionOnly:FALSE domain:"localhost" path:"/" isSecure:FALSE&gt;
</code></pre></div></div>

<h2 id="使用cookie的注意点">使用cookie的注意点</h2>
<hr />

<h3 id="cookie的性能影响">Cookie的性能影响</h3>
<p>由于Cookie的实现机制，除非Cookie过期，否则浏览器每次请求都会向服务器发送Cookie，一旦Cookie设置过多，会导致请求报头过大，造成带宽的浪费。因此，对Cookie的性能优化也是值得关注的一个问题。如何进行性能优化？</p>

<ul>
  <li>减小Cookie的大小</li>
  <li>为不需要Cookie的组件换个域名，以减少无效Cookie的传输</li>
  <li>减少DNS查询</li>
</ul>

<h2 id="demo">demo</h2>
<hr />

<p><a href="https://github.com/coolnameismy/demo/tree/master/network-demo">本文的demo下载</a></p>

<p>感谢收看，如果对大家有帮助，请<a href="https://github.com/coolnameismy">github上follow和star</a>，本文发布在<a href="https://zsmsimon.github.io/">刘彦玮的技术博客</a>，转载请注明出处</p>

<h2 id="参考阅读">参考阅读</h2>
<hr />

<ul>
  <li><a href="http://www.tuicool.com/articles/F3UF7n">node.js操作Cookie</a></li>
  <li><a href="http://www.jianshu.com/p/51d85be2e0e8">【深入浅出NodeJS】Cookie&amp;Session机制详解#1</a></li>
  <li><a href="https://nodejs.org/docs/latest/api/http.html">nodejs api</a></li>
  <li>jack Cox[M] iOS网络高级编程-iphone和ipad企业应用开发 张龙 译．-北京 清华大学出版社，2014(2015.8重印)</li>
</ul>

    <div class="declare">
        <div>

        </div>
    </div>
</article>
<!-- end #post__content -->

<div id="post__share">
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=http://localhost:4000/2016/02/13/ios-networking-5.html&text=iOS networking（五）网络请求中的cookie" target="_blank"></a>
  <a id="icon-cc" class="fontello" href="http://github.com/ZSMSimon" target="_blank"></a>
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=http://localhost:4000/2016/02/13/ios-networking-5.html&title=iOS networking（五）网络请求中的cookie" target="_blank"></a>
    <!-- <div class="share-info">分享一下~</div> -->
</div>
<div id="qrcode" >
	<img src="http://localhost:4000/assets/images/qrcode.jpg" style="margin: 0 auto;display: block;" width="200" height="200" alt="">
</div>
<!-- end #post__share -->
<div id="disqus_thread" name="coolnameismy">
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink" target="_blank">Loading Disqus comments...</a>
</div>


            <!---->
    <!--<p id="copyright">Powered by <a href="http://jekyllrb.com" target="_blank">Jekyll</a>-->
    <!--&nbsp;&nbsp;|&nbsp;&nbsp;Theme <a href="https://github.com/P233/3-Jekyll" target="_blank">3-Jekyll</a>-->
    <!--&nbsp;&nbsp;|&nbsp;&nbsp;Hosted on <a href="https://pages.github.com" target="_blank">Github</a></p>-->
      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">Table of Contents</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
    </div> <!-- end #post -->

    <button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>

<script src="/assets/js/jquery.js"></script>
<script src="/assets/js/jquery.pjax.js"></script>
<script src="/assets/js/nprogress.js"></script>
<script src="/assets/js/searchbox.js"></script>
<script src="/assets/js/script.js"></script>


    <script>
    //百度站点统计,排除localhost
    if(window.location.host.indexOf("localhost") ==-1 &&  window.location.host.indexOf("127.0.0.1") == -1){

        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?2c1583237ca3f5343d8dab0140019ca7";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    }
</script>
   </body>
 </html>